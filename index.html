<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baba Society ‚öΩ</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#22c55e">

<style>
:root{
  --bg:#0f172a; --card:#111827;
  --primary:#22c55e; --secondary:#38bdf8;
  --danger:#ef4444; --warning:#facc15;
  --text:#e5e7eb;
}
body{margin:0;font-family:Arial;background:var(--bg);color:var(--text);}
.container{max-width:900px;margin:auto;padding:12px;}
h1,h2{text-align:center;}
.card{background:var(--card);border-radius:14px;padding:12px;margin-bottom:12px;}
button{border:none;border-radius:10px;padding:10px;cursor:pointer;font-weight:bold;width:100%;}
.btn-primary{background:var(--primary);}
.btn-secondary{background:var(--secondary);}
.btn-danger{background:var(--danger);color:#fff;}
.btn-warning{background:var(--warning);}
input,select{width:100%;padding:10px;border-radius:10px;border:none;margin-bottom:8px;}

.player-box{
  background:#020617;
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
}
.player-added{background:#052e16;}
.actions{display:flex;gap:6px;margin-top:6px;}
.small-btn{padding:6px 10px;border-radius:8px;}

.team{border:1px solid #1f2933;border-radius:12px;padding:10px;margin-bottom:10px;}
.team h3{color:var(--secondary);}
.badges{display:flex;gap:12px;font-size:14px;margin-bottom:6px;}
</style>
</head>

<body>
<div class="container">
<h1>Baba Society ‚öΩ</h1>

<div class="card">
<h2 id="formTitle">Adicionar jogador</h2>
<input id="nameInput" placeholder="Nome do jogador">
<select id="position">
  <option>Zagueiro</option>
  <option>Meia</option>
  <option>Atacante</option>
</select>
<select id="rating"></select>

<button class="btn-primary" onclick="savePlayer()" id="saveBtn">Salvar jogador</button>
<button class="btn-secondary" onclick="cancelEdit()" id="cancelBtn" style="display:none">Cancelar edi√ß√£o</button>
</div>

<div class="card">
<h2>Jogadores salvos</h2>
<div id="savedPlayers"></div>
</div>

<div class="card">
<h2>Lista do dia (<span id="count">0</span>)</h2>
<div id="todayPlayers"></div>
<button class="btn-secondary" onclick="drawTeams()">Sortear times</button>
<button class="btn-primary" onclick="shareWhatsApp()">üì≤ Compartilhar no WhatsApp</button>
</div>

<div class="card">
<h2>Times</h2>
<div id="teams"></div>
</div>
</div>

<script>
/* ===== ESTADO ===== */
let players = JSON.parse(localStorage.getItem("players")) || [];
let today = [];
let editingIndex = null;
let lastTeams = [];
let lastLeftovers = [];

/* ===== ELEMENTOS ===== */
const nameInput = document.getElementById("nameInput");
const ratingSelect = document.getElementById("rating");
const savedPlayersDiv = document.getElementById("savedPlayers");
const todayPlayersDiv = document.getElementById("todayPlayers");
const teamsDiv = document.getElementById("teams");
const countSpan = document.getElementById("count");

/* ===== UTIL ===== */
for(let i=1;i<=10;i++){
  const o=document.createElement("option");
  o.value=i;
  o.textContent="‚≠ê".repeat(i);
  ratingSelect.appendChild(o);
}
const stars=n=>"‚≠ê".repeat(n);
const posEmoji=p=>p==="Zagueiro"?"üõ°Ô∏è":p==="Meia"?"üéØ":"‚öΩ";

/* ===== CRUD ===== */
function savePlayer(){
  const name=nameInput.value.trim();
  if(!name) return;

  const pos=position.value;
  const rat=parseInt(rating.value);

  if(editingIndex!==null){
    players[editingIndex].position=pos;
    players[editingIndex].rating=rat;
    cancelEdit();
  }else{
    if(players.some(p=>p.name===name)){
      alert("Jogador j√° existe");
      return;
    }
    players.push({name,position:pos,rating:rat});
  }

  localStorage.setItem("players",JSON.stringify(players));
  nameInput.value="";
  renderSaved();
}

function editPlayer(i){
  const p=players[i];
  nameInput.value=p.name;
  nameInput.disabled=true;
  position.value=p.position;
  rating.value=p.rating;
  editingIndex=i;
  formTitle.textContent="Editar jogador";
  saveBtn.textContent="Salvar edi√ß√£o";
  cancelBtn.style.display="block";
}

function cancelEdit(){
  editingIndex=null;
  nameInput.value="";
  nameInput.disabled=false;
  formTitle.textContent="Adicionar jogador";
  saveBtn.textContent="Salvar jogador";
  cancelBtn.style.display="none";
}

/* ===== LISTAS ===== */
function toggleToday(name){
  const p=players.find(x=>x.name===name);
  today.includes(p)?today=today.filter(x=>x!==p):today.push(p);
  renderToday();renderSaved();
}

function renderSaved(){
  savedPlayersDiv.innerHTML="";
  players.forEach((p,i)=>{
    const added=today.includes(p);
    savedPlayersDiv.innerHTML+=`
      <div class="player-box ${added?'player-added':''}">
        <strong>${p.name}</strong><br>
        ${posEmoji(p.position)} ${p.position}<br>
        ${stars(p.rating)}
        <div class="actions">
          <button class="small-btn btn-warning" onclick="editPlayer(${i})">‚úèÔ∏è</button>
          <button class="small-btn btn-primary" onclick="toggleToday('${p.name}')">
            ${added?'‚úî':'+'}
          </button>
        </div>
      </div>`;
  });
}

function renderToday(){
  countSpan.textContent=today.length;
  todayPlayersDiv.innerHTML=today.map(p=>`
    <div class="player-box">
      ${p.name}
      <button class="small-btn btn-danger" onclick="toggleToday('${p.name}')">x</button>
    </div>`).join("");
}

/* ===== SORTEIO COM EQUIL√çBRIO ===== */
function drawTeams(){
  teamsDiv.innerHTML="";
  lastTeams=[]; lastLeftovers=[];

  if(today.length<12){
    alert("M√≠nimo de 12 jogadores");
    return;
  }

  const TEAM_SIZE=6;
  const teamCount=Math.floor(today.length/TEAM_SIZE);
  const usableCount=teamCount*TEAM_SIZE;

  const shuffled=[...today].sort(()=>Math.random()-0.5);
  const usable=shuffled.slice(0,usableCount);
  lastLeftovers=shuffled.slice(usableCount);

  let zagueiros=usable.filter(p=>p.position==="Zagueiro").sort((a,b)=>b.rating-a.rating);
  let meias=usable.filter(p=>p.position==="Meia").sort((a,b)=>b.rating-a.rating);
  let atacantes=usable.filter(p=>p.position==="Atacante").sort((a,b)=>b.rating-a.rating);

  let teams=Array.from({length:teamCount},()=>[]);
  const avg=t=>t.length?t.reduce((s,p)=>s+p.rating,0)/t.length:0;

  function safeAdd(team,player){
    if(team.length<TEAM_SIZE){ team.push(player); return true;}
    return false;
  }

  for(let i=0;i<teamCount;i++){
    if(zagueiros.length) safeAdd(teams[i],zagueiros.shift());
    if(meias.length) safeAdd(teams[i],meias.shift());
    if(atacantes.length) safeAdd(teams[i],atacantes.shift());
  }

  function distribute(group){
    while(group.length){
      let available=teams.filter(t=>t.length<TEAM_SIZE);
      if(!available.length) break;

      available.sort((a,b)=>avg(a)-avg(b));
      safeAdd(available[0],group.shift());
      if(!group.length) break;

      available=teams.filter(t=>t.length<TEAM_SIZE);
      if(!available.length) break;

      available.sort((a,b)=>avg(b)-avg(a));
      safeAdd(available[0],group.pop());
    }
  }

  distribute(zagueiros);
  distribute(meias);
  distribute(atacantes);

  renderTeams(teams,lastLeftovers);
}

/* ===== RENDER TIMES ===== */
function renderTeams(teams,leftovers){
  teamsDiv.innerHTML="";
  teams.forEach(t=>{
    const best=t.reduce((a,b)=>b.rating>a.rating?b:a);
    const avgTeam=(t.reduce((s,p)=>s+p.rating,0)/t.length).toFixed(1);
    lastTeams.push({name:best.name,players:t});

    const c={Zagueiro:0,Meia:0,Atacante:0};
    t.forEach(p=>c[p.position]++);

    teamsDiv.innerHTML+=`
      <div class="team">
        <h3>Time ${best.name} ‚≠ê ${avgTeam}</h3>
        <div class="badges">
          üõ°Ô∏è ${c.Zagueiro} üéØ ${c.Meia} ‚öΩ ${c.Atacante}
        </div>
        ${t.map(p=>p.name).join("<br>")}
      </div>`;
  });

  if(leftovers.length){
    teamsDiv.innerHTML+=`
      <div class="team">
        <h3>Time incompleto</h3>
        ${leftovers.map(p=>p.name).join("<br>")}
      </div>`;
  }
}

/* ===== WHATSAPP ===== */
function shareWhatsApp(){
  if(!lastTeams.length){
    alert("Sorteie os times primeiro");
    return;
  }

  let text="Baba Society ‚Äì Times do dia \n\n";
  lastTeams.forEach(t=>{
    text+=`Time ${t.name}\n`;
    t.players.forEach(p=>text+=`- ${p.name}\n`);
    text+="\n";
  });

  if(lastLeftovers.length){
    text+="Time de fora\n";
    lastLeftovers.forEach(p=>text+=`- ${p.name}\n`);
  }

  window.open("https://wa.me/?text="+encodeURIComponent(text),"_blank");
}

/* INIT */
renderSaved(); renderToday();
</script>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
